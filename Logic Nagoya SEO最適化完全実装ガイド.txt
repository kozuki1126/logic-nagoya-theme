<?php
/**
 * Logic Nagoya - SEO最適化完全実装ガイド
 * 
 * 検索エンジン最適化のための包括的なソリューション
 * - 構造化データ（Schema.org）
 * - メタタグ動的生成
 * - XMLサイトマップ
 * - ローカルSEO対策
 * - SNS最適化（OGP, Twitter Cards）
 */

// ============================================================
// 1. 基本SEO設定とメタタグ
// ============================================================

/**
 * SEO基本設定の初期化
 */
function logic_nagoya_seo_init() {
    // テーマサポートの追加
    add_theme_support('title-tag');
    
    // カスタムメタタグの追加
    add_action('wp_head', 'logic_nagoya_meta_tags', 1);
    add_action('wp_head', 'logic_nagoya_structured_data', 5);
    add_action('wp_head', 'logic_nagoya_social_meta', 10);
    
    // XMLサイトマップの設定
    add_action('init', 'logic_nagoya_sitemap_init');
    
    // robots.txtの最適化
    add_filter('robots_txt', 'logic_nagoya_robots_txt');
    
    // カノニカルURLの設定
    add_action('wp_head', 'logic_nagoya_canonical_url');
}
add_action('after_setup_theme', 'logic_nagoya_seo_init');

/**
 * 動的メタタグの生成
 */
function logic_nagoya_meta_tags() {
    // メタディスクリプション
    $description = logic_nagoya_get_meta_description();
    if ($description) {
        echo '<meta name="description" content="' . esc_attr($description) . '">' . "\n";
    }
    
    // メタキーワード（必要に応じて）
    $keywords = logic_nagoya_get_meta_keywords();
    if ($keywords) {
        echo '<meta name="keywords" content="' . esc_attr($keywords) . '">' . "\n";
    }
    
    // viewport（レスポンシブ対応）
    echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' . "\n";
    
    // 文字エンコーディング
    echo '<meta charset="' . get_bloginfo('charset') . '">' . "\n";
    
    // その他のメタタグ
    echo '<meta name="format-detection" content="telephone=yes">' . "\n";
    echo '<meta name="theme-color" content="#ca6666">' . "\n";
    
    // 検索エンジン向け指示
    if (is_search() || is_404()) {
        echo '<meta name="robots" content="noindex, nofollow">' . "\n";
    } else {
        echo '<meta name="robots" content="index, follow">' . "\n";
    }
}

/**
 * メタディスクリプションの動的生成
 */
function logic_nagoya_get_meta_description() {
    $description = '';
    
    if (is_home() || is_front_page()) {
        $description = 'Logic Nagoyaは名古屋栄のプレミアムライブハウス。最新音響・照明設備でライブ、トークイベント、配信まで対応。';
        
    } elseif (is_singular('event')) {
        $event_date = get_field('event_date');
        $description = 'Logic Nagoyaで開催される「' . get_the_title() . '」';
        
        if ($event_date) {
            $description .= '（' . date('Y年m月d日', strtotime($event_date)) . '開催）';
        }
        
        $excerpt = get_the_excerpt();
        if ($excerpt) {
            $description .= 'の詳細情報。' . wp_trim_words($excerpt, 15, '...');
        }
        
    } elseif (is_post_type_archive('event')) {
        $description = 'Logic Nagoyaで開催される今後のイベント一覧。ライブ、トークショー、配信イベントなど多彩なラインナップ。';
        
    } elseif (is_page('about')) {
        $description = '名古屋栄のライブハウス「Logic Nagoya」の会社概要、コンセプト、特徴をご紹介。';
        
    } elseif (is_page('equipment')) {
        $description = 'Logic Nagoyaの音響・照明・映像機材の詳細リスト。プロフェッショナルな設備でイベントをサポート。';
        
    } elseif (is_page('pricing')) {
        $description = 'Logic Nagoyaの利用料金とシステムのご案内。ライブから配信まで様々な用途に対応した料金プラン。';
        
    } elseif (is_singular()) {
        $excerpt = get_the_excerpt();
        if ($excerpt) {
            $description = wp_trim_words($excerpt, 25, '...');
        }
        
    } elseif (is_category() || is_tag() || is_tax()) {
        $term = get_queried_object();
        if ($term && $term->description) {
            $description = wp_trim_words($term->description, 25, '...');
        }
    }
    
    // 文字数制限（160文字以下）
    if (mb_strlen($description) > 160) {
        $description = mb_substr($description, 0, 157) . '...';
    }
    
    return $description;
}

/**
 * メタキーワードの生成
 */
function logic_nagoya_get_meta_keywords() {
    $keywords = ['Logic Nagoya', 'ライブハウス', '名古屋', '栄'];
    
    if (is_singular('event')) {
        $terms = get_the_terms(get_the_ID(), 'event_category');
        if ($terms) {
            foreach ($terms as $term) {
                $keywords[] = $term->name;
            }
        }
        $keywords[] = 'イベント';
        $keywords[] = 'ライブ';
        
    } elseif (is_page('equipment')) {
        $keywords = array_merge($keywords, ['音響機材', '照明', '映像', '設備']);
        
    } elseif (is_page('pricing')) {
        $keywords = array_merge($keywords, ['料金', '貸切', 'レンタル']);
    }
    
    return implode(', ', array_unique($keywords));
}

// ============================================================
// 2. 構造化データ（Schema.org JSON-LD）
// ============================================================

/**
 * 構造化データの出力
 */
function logic_nagoya_structured_data() {
    $schema_data = [];
    
    // 基本的な組織情報
    $schema_data[] = logic_nagoya_organization_schema();
    
    // ローカルビジネス情報
    $schema_data[] = logic_nagoya_local_business_schema();
    
    // ページ固有の構造化データ
    if (is_singular('event')) {
        $schema_data[] = logic_nagoya_event_schema();
    } elseif (is_front_page() || is_home()) {
        $schema_data[] = logic_nagoya_website_schema();
    } elseif (is_page('about')) {
        $schema_data[] = logic_nagoya_about_page_schema();
    }
    
    // パンくずリスト
    if (!is_front_page()) {
        $schema_data[] = logic_nagoya_breadcrumb_schema();
    }
    
    // JSON-LD形式で出力
    foreach ($schema_data as $schema) {
        if (!empty($schema)) {
            echo '<script type="application/ld+json">' . "\n";
            echo json_encode($schema, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT) . "\n";
            echo '</script>' . "\n";
        }
    }
}

/**
 * 組織情報のスキーマ
 */
function logic_nagoya_organization_schema() {
    $contact_info = get_field('contact_info', 'option');
    $social_media = get_field('social_media', 'option');
    
    return [
        '@context' => 'https://schema.org',
        '@type' => 'Organization',
        'name' => 'Logic Nagoya',
        'alternateName' => 'ロジックナゴヤ',
        'url' => home_url('/'),
        'logo' => get_template_directory_uri() . '/assets/images/logo.png',
        'description' => '名古屋栄のプレミアムライブハウス。最新設備でライブ、トークイベント、配信をサポート。',
        'address' => [
            '@type' => 'PostalAddress',
            'streetAddress' => $contact_info['address'] ?? '愛知県名古屋市中区栄3-13-31',
            'addressLocality' => '名古屋市',
            'addressRegion' => '愛知県',
            'postalCode' => '460-0008',
            'addressCountry' => 'JP'
        ],
        'contactPoint' => [
            '@type' => 'ContactPoint',
            'telephone' => $contact_info['phone'] ?? '052-241-7772',
            'email' => $contact_info['email'] ?? 'info@logicnagoya.com',
            'contactType' => 'customer service',
            'availableLanguage' => 'Japanese'
        ],
        'sameAs' => array_filter([
            $social_media['twitter_url'] ?? '',
            $social_media['facebook_url'] ?? '',
            $social_media['instagram_url'] ?? '',
            $social_media['youtube_url'] ?? ''
        ])
    ];
}

/**
 * ローカルビジネス情報のスキーマ
 */
function logic_nagoya_local_business_schema() {
    $contact_info = get_field('contact_info', 'option');
    
    return [
        '@context' => 'https://schema.org',
        '@type' => 'MusicVenue',
        'name' => 'Logic Nagoya',
        'image' => get_template_directory_uri() . '/assets/images/venue-photo.jpg',
        'description' => '名古屋栄にあるライブハウス。音響・照明・映像設備を完備し、ライブイベントから配信まで対応。',
        'address' => [
            '@type' => 'PostalAddress',
            'streetAddress' => $contact_info['address'] ?? '愛知県名古屋市中区栄3-13-31',
            'addressLocality' => '名古屋市',
            'addressRegion' => '愛知県',
            'postalCode' => '460-0008',
            'addressCountry' => 'JP'
        ],
        'geo' => [
            '@type' => 'GeoCoordinates',
            'latitude' => 35.168251,
            'longitude' => 136.906239
        ],
        'telephone' => $contact_info['phone'] ?? '052-241-7772',
        'email' => $contact_info['email'] ?? 'info@logicnagoya.com',
        'url' => home_url('/'),
        'priceRange' => '¥¥',
        'currenciesAccepted' => 'JPY',
        'paymentAccepted' => 'Cash, Credit Card',
        'openingHours' => 'Mo-Su 10:00-22:00',
        'amenityFeature' => [
            [
                '@type' => 'LocationFeatureSpecification',
                'name' => '音響設備',
                'value' => 'd&b audiotechnik PAシステム'
            ],
            [
                '@type' => 'LocationFeatureSpecification',
                'name' => '照明設備',
                'value' => 'LED照明・ムービングライト完備'
            ],
            [
                '@type' => 'LocationFeatureSpecification',
                'name' => '配信設備',
                'value' => 'マルチカメラ配信対応'
            ]
        ]
    ];
}

/**
 * イベント情報のスキーマ
 */
function logic_nagoya_event_schema() {
    if (!is_singular('event')) {
        return null;
    }
    
    $event_date = get_field('event_date');
    $event_time_open = get_field('event_time_open');
    $pricing = get_field('event_pricing');
    $performers = get_field('event_performers');
    $contact_info = get_field('contact_info', 'option');
    
    $start_date = $event_date;
    if ($event_time_open) {
        $start_date .= 'T' . $event_time_open . ':00';
    }
    
    $schema = [
        '@context' => 'https://schema.org',
        '@type' => 'MusicEvent',
        'name' => get_the_title(),
        'description' => get_the_excerpt() ?: get_the_content(),
        'url' => get_permalink(),
        'startDate' => $start_date,
        'location' => [
            '@type' => 'MusicVenue',
            'name' => 'Logic Nagoya',
            'address' => [
                '@type' => 'PostalAddress',
                'streetAddress' => $contact_info['address'] ?? '愛知県名古屋市中区栄3-13-31',
                'addressLocality' => '名古屋市',
                'addressRegion' => '愛知県',
                'addressCountry' => 'JP'
            ]
        ],
        'organizer' => [
            '@type' => 'Organization',
            'name' => 'Logic Nagoya',
            'url' => home_url('/')
        ]
    ];
    
    // 出演者情報
    if ($performers && is_array($performers)) {
        $schema['performer'] = [];
        foreach ($performers as $performer) {
            $schema['performer'][] = [
                '@type' => 'MusicGroup',
                'name' => $performer['performer_name'],
                'description' => $performer['performer_bio'] ?? ''
            ];
        }
    }
    
    // チケット情報
    if ($pricing && ($pricing['price_advance'] || $pricing['price_door'])) {
        $offers = [];
        
        if ($pricing['price_advance']) {
            $offers[] = [
                '@type' => 'Offer',
                'name' => '前売りチケット',
                'price' => $pricing['price_advance'],
                'priceCurrency' => 'JPY',
                'availability' => 'https://schema.org/InStock',
                'validFrom' => date('Y-m-d')
            ];
        }
        
        if ($pricing['price_door']) {
            $offers[] = [
                '@type' => 'Offer',
                'name' => '当日券',
                'price' => $pricing['price_door'],
                'priceCurrency' => 'JPY',
                'availability' => 'https://schema.org/InStock'
            ];
        }
        
        $schema['offers'] = $offers;
    }
    
    // イベント画像
    if (has_post_thumbnail()) {
        $schema['image'] = get_the_post_thumbnail_url(get_the_ID(), 'large');
    }
    
    return $schema;
}

/**
 * ウェブサイト情報のスキーマ
 */
function logic_nagoya_website_schema() {
    return [
        '@context' => 'https://schema.org',
        '@type' => 'WebSite',
        'name' => get_bloginfo('name'),
        'description' => get_bloginfo('description'),
        'url' => home_url('/'),
        'potentialAction' => [
            '@type' => 'SearchAction',
            'target' => home_url('/?s={search_term_string}'),
            'query-input' => 'required name=search_term_string'
        ]
    ];
}

/**
 * パンくずリストのスキーマ
 */
function logic_nagoya_breadcrumb_schema() {
    $breadcrumbs = logic_nagoya_get_breadcrumbs();
    
    if (empty($breadcrumbs)) {
        return null;
    }
    
    $list_items = [];
    foreach ($breadcrumbs as $index => $breadcrumb) {
        $list_items[] = [
            '@type' => 'ListItem',
            'position' => $index + 1,
            'name' => $breadcrumb['title'],
            'item' => $breadcrumb['url']
        ];
    }
    
    return [
        '@context' => 'https://schema.org',
        '@type' => 'BreadcrumbList',
        'itemListElement' => $list_items
    ];
}

// ============================================================
// 3. SNS最適化（Open Graph、Twitter Cards）
// ============================================================

/**
 * ソーシャルメディア用メタタグ
 */
function logic_nagoya_social_meta() {
    // Open Graph
    logic_nagoya_open_graph_tags();
    
    // Twitter Cards
    logic_nagoya_twitter_card_tags();
}

/**
 * Open Graph タグ
 */
function logic_nagoya_open_graph_tags() {
    echo '<meta property="og:site_name" content="' . esc_attr(get_bloginfo('name')) . '">' . "\n";
    echo '<meta property="og:locale" content="ja_JP">' . "\n";
    
    if (is_singular()) {
        echo '<meta property="og:type" content="article">' . "\n";
        echo '<meta property="og:title" content="' . esc_attr(get_the_title()) . '">' . "\n";
        echo '<meta property="og:description" content="' . esc_attr(logic_nagoya_get_meta_description()) . '">' . "\n";
        echo '<meta property="og:url" content="' . esc_url(get_permalink()) . '">' . "\n";
        
        if (has_post_thumbnail()) {
            $image = wp_get_attachment_image_src(get_post_thumbnail_id(), 'large');
            echo '<meta property="og:image" content="' . esc_url($image[0]) . '">' . "\n";
            echo '<meta property="og:image:width" content="' . esc_attr($image[1]) . '">' . "\n";
            echo '<meta property="og:image:height" content="' . esc_attr($image[2]) . '">' . "\n";
        }
        
        // 記事固有の情報
        echo '<meta property="article:published_time" content="' . get_the_date('c') . '">' . "\n";
        echo '<meta property="article:modified_time" content="' . get_the_modified_date('c') . '">' . "\n";
        
    } else {
        echo '<meta property="og:type" content="website">' . "\n";
        echo '<meta property="og:title" content="' . esc_attr(wp_get_document_title()) . '">' . "\n";
        echo '<meta property="og:description" content="' . esc_attr(logic_nagoya_get_meta_description()) . '">' . "\n";
        echo '<meta property="og:url" content="' . esc_url(home_url(add_query_arg([], $_SERVER['REQUEST_URI']))) . '">' . "\n";
        
        // デフォルト画像
        $default_image = get_template_directory_uri() . '/assets/images/og-default.jpg';
        echo '<meta property="og:image" content="' . esc_url($default_image) . '">' . "\n";
    }
}

/**
 * Twitter Card タグ
 */
function logic_nagoya_twitter_card_tags() {
    echo '<meta name="twitter:card" content="summary_large_image">' . "\n";
    echo '<meta name="twitter:site" content="@logicnagoya">' . "\n";
    echo '<meta name="twitter:title" content="' . esc_attr(wp_get_document_title()) . '">' . "\n";
    echo '<meta name="twitter:description" content="' . esc_attr(logic_nagoya_get_meta_description()) . '">' . "\n";
    
    if (is_singular() && has_post_thumbnail()) {
        $image = wp_get_attachment_image_src(get_post_thumbnail_id(), 'large');
        echo '<meta name="twitter:image" content="' . esc_url($image[0]) . '">' . "\n";
    } else {
        $default_image = get_template_directory_uri() . '/assets/images/twitter-default.jpg';
        echo '<meta name="twitter:image" content="' . esc_url($default_image) . '">' . "\n";
    }
}

// ============================================================
// 4. XMLサイトマップ
// ============================================================

/**
 * XMLサイトマップの初期化
 */
function logic_nagoya_sitemap_init() {
    // カスタムサイトマップの生成
    add_action('init', 'logic_nagoya_sitemap_rewrite_rules');
    add_action('template_redirect', 'logic_nagoya_sitemap_template');
}

/**
 * サイトマップ用のリライトルール
 */
function logic_nagoya_sitemap_rewrite_rules() {
    add_rewrite_rule('^sitemap\.xml$', 'index.php?sitemap=main', 'top');
    add_rewrite_rule('^sitemap-([^/]+)\.xml$', 'index.php?sitemap=$matches[1]', 'top');
}

/**
 * サイトマップのテンプレート処理
 */
function logic_nagoya_sitemap_template() {
    $sitemap = get_query_var('sitemap');
    
    if (!$sitemap) {
        return;
    }
    
    header('Content-Type: application/xml; charset=utf-8');
    header('X-Robots-Tag: noindex');
    
    switch ($sitemap) {
        case 'main':
            logic_nagoya_main_sitemap();
            break;
        case 'posts':
            logic_nagoya_posts_sitemap();
            break;
        case 'events':
            logic_nagoya_events_sitemap();
            break;
        case 'pages':
            logic_nagoya_pages_sitemap();
            break;
        default:
            status_header(404);
            exit;
    }
    
    exit;
}

/**
 * メインサイトマップ（サイトマップインデックス）
 */
function logic_nagoya_main_sitemap() {
    echo '<?xml version="1.0" encoding="UTF-8"?>' . "\n";
    echo '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . "\n";
    
    // ページサイトマップ
    echo '<sitemap>' . "\n";
    echo '<loc>' . home_url('/sitemap-pages.xml') . '</loc>' . "\n";
    echo '<lastmod>' . date('Y-m-d\TH:i:s+00:00') . '</lastmod>' . "\n";
    echo '</sitemap>' . "\n";
    
    // イベントサイトマップ
    echo '<sitemap>' . "\n";
    echo '<loc>' . home_url('/sitemap-events.xml') . '</loc>' . "\n";
    echo '<lastmod>' . date('Y-m-d\TH:i:s+00:00') . '</lastmod>' . "\n";
    echo '</sitemap>' . "\n";
    
    echo '</sitemapindex>' . "\n";
}

/**
 * イベントサイトマップ
 */
function logic_nagoya_events_sitemap() {
    echo '<?xml version="1.0" encoding="UTF-8"?>' . "\n";
    echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . "\n";
    
    // イベント一覧ページ
    echo '<url>' . "\n";
    echo '<loc>' . get_post_type_archive_link('event') . '</loc>' . "\n";
    echo '<lastmod>' . date('Y-m-d\TH:i:s+00:00') . '</lastmod>' . "\n";
    echo '<changefreq>daily</changefreq>' . "\n";
    echo '<priority>0.8</priority>' . "\n";
    echo '</url>' . "\n";
    
    // 個別イベントページ
    $events = get_posts([
        'post_type' => 'event',
        'posts_per_page' => -1,
        'post_status' => 'publish'
    ]);
    
    foreach ($events as $event) {
        echo '<url>' . "\n";
        echo '<loc>' . get_permalink($event->ID) . '</loc>' . "\n";
        echo '<lastmod>' . get_the_modified_date('Y-m-d\TH:i:s+00:00', $event->ID) . '</lastmod>' . "\n";
        echo '<changefreq>weekly</changefreq>' . "\n";
        echo '<priority>0.6</priority>' . "\n";
        echo '</url>' . "\n";
    }
    
    echo '</urlset>' . "\n";
}

/**
 * ページサイトマップ
 */
function logic_nagoya_pages_sitemap() {
    echo '<?xml version="1.0" encoding="UTF-8"?>' . "\n";
    echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' . "\n";
    
    // トップページ
    echo '<url>' . "\n";
    echo '<loc>' . home_url('/') . '</loc>' . "\n";
    echo '<lastmod>' . date('Y-m-d\TH:i:s+00:00') . '</lastmod>' . "\n";
    echo '<changefreq>daily</changefreq>' . "\n";
    echo '<priority>1.0</priority>' . "\n";
    echo '</url>' . "\n";
    
    // 固定ページ
    $pages = get_pages([
        'post_status' => 'publish',
        'sort_column' => 'menu_order'
    ]);
    
    foreach ($pages as $page) {
        $priority = '0.8';
        $changefreq = 'monthly';
        
        // 重要ページの優先度調整
        if (in_array($page->post_name, ['about', 'equipment', 'pricing'])) {
            $priority = '0.9';
            $changefreq = 'weekly';
        }
        
        echo '<url>' . "\n";
        echo '<loc>' . get_permalink($page->ID) . '</loc>' . "\n";
        echo '<lastmod>' . get_the_modified_date('Y-m-d\TH:i:s+00:00', $page->ID) . '</lastmod>' . "\n";
        echo '<changefreq>' . $changefreq . '</changefreq>' . "\n";
        echo '<priority>' . $priority . '</priority>' . "\n";
        echo '</url>' . "\n";
    }
    
    echo '</urlset>' . "\n";
}

// ============================================================
// 5. パンくずリスト
// ============================================================

/**
 * パンくずリストの生成
 */
function logic_nagoya_get_breadcrumbs() {
    $breadcrumbs = [];
    
    // ホーム
    $breadcrumbs[] = [
        'title' => 'ホーム',
        'url' => home_url('/')
    ];
    
    if (is_singular('event')) {
        $breadcrumbs[] = [
            'title' => 'イベント',
            'url' => get_post_type_archive_link('event')
        ];
        $breadcrumbs[] = [
            'title' => get_the_title(),
            'url' => get_permalink()
        ];
        
    } elseif (is_post_type_archive('event')) {
        $breadcrumbs[] = [
            'title' => 'イベント',
            'url' => get_post_type_archive_link('event')
        ];
        
    } elseif (is_page()) {
        $breadcrumbs[] = [
            'title' => get_the_title(),
            'url' => get_permalink()
        ];
        
    } elseif (is_category() || is_tag() || is_tax()) {
        $term = get_queried_object();
        $breadcrumbs[] = [
            'title' => $term->name,
            'url' => get_term_link($term)
        ];
    }
    
    return $breadcrumbs;
}

/**
 * パンくずリストのHTML出力
 */
function logic_nagoya_breadcrumbs_html() {
    $breadcrumbs = logic_nagoya_get_breadcrumbs();
    
    if (count($breadcrumbs) <= 1) {
        return '';
    }
    
    $html = '<nav class="breadcrumbs" aria-label="パンくずリスト">';
    $html .= '<ol class="breadcrumbs-list">';
    
    foreach ($breadcrumbs as $index => $breadcrumb) {
        $html .= '<li class="breadcrumbs-item">';
        
        if ($index === count($breadcrumbs) - 1) {
            // 最後の項目（現在のページ）
            $html .= '<span class="breadcrumbs-current">' . esc_html($breadcrumb['title']) . '</span>';
        } else {
            $html .= '<a href="' . esc_url($breadcrumb['url']) . '">' . esc_html($breadcrumb['title']) . '</a>';
            $html .= '<span class="breadcrumbs-separator"> › </span>';
        }
        
        $html .= '</li>';
    }
    
    $html .= '</ol>';
    $html .= '</nav>';
    
    return $html;
}

// ============================================================
// 6. カノニカルURL
// ============================================================

/**
 * カノニカルURLの設定
 */
function logic_nagoya_canonical_url() {
    $canonical_url = '';
    
    if (is_home() || is_front_page()) {
        $canonical_url = home_url('/');
    } elseif (is_singular()) {
        $canonical_url = get_permalink();
    } elseif (is_post_type_archive()) {
        $canonical_url = get_post_type_archive_link(get_query_var('post_type'));
    } elseif (is_category() || is_tag() || is_tax()) {
        $canonical_url = get_term_link(get_queried_object());
    }
    
    if ($canonical_url) {
        echo '<link rel="canonical" href="' . esc_url($canonical_url) . '">' . "\n";
    }
}

// ============================================================
// 7. robots.txt最適化
// ============================================================

/**
 * robots.txtの最適化
 */
function logic_nagoya_robots_txt($output) {
    $robots_content = "User-agent: *\n";
    $robots_content .= "Disallow: /wp-admin/\n";
    $robots_content .= "Disallow: /wp-includes/\n";
    $robots_content .= "Disallow: /wp-content/plugins/\n";
    $robots_content .= "Disallow: /wp-content/themes/\n";
    $robots_content .= "Disallow: /?s=\n";
    $robots_content .= "Disallow: /search/\n";
    $robots_content .= "Disallow: /author/\n";
    $robots_content .= "Disallow: */trackback/\n";
    $robots_content .= "Disallow: */feed/\n";
    $robots_content .= "Disallow: */comments/\n";
    $robots_content .= "Disallow: *?replytocom\n";
    $robots_content .= "Disallow: *?attachment_id\n";
    $robots_content .= "\n";
    $robots_content .= "Allow: /wp-content/uploads/\n";
    $robots_content .= "\n";
    $robots_content .= "Sitemap: " . home_url('/sitemap.xml') . "\n";
    
    return $robots_content;
}

// ============================================================
// 8. Analytics・Search Console連携
// ============================================================

/**
 * Google Analytics・Tag Manager の設定
 */
function logic_nagoya_analytics_code() {
    $seo_settings = get_field('seo_settings', 'option');
    
    if (!$seo_settings) {
        return;
    }
    
    // Google Tag Manager (Head)
    if (!empty($seo_settings['google_tag_manager'])) {
        echo "<!-- Google Tag Manager -->\n";
        echo "<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n";
        echo "new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n";
        echo "j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=\n";
        echo "'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);\n";
        echo "})(window,document,'script','dataLayer','" . esc_js($seo_settings['google_tag_manager']) . "');</script>\n";
        echo "<!-- End Google Tag Manager -->\n";
    }
    
    // Google Analytics (GA4)
    if (!empty($seo_settings['google_analytics'])) {
        echo "<!-- Google Analytics -->\n";
        echo "<script async src='https://www.googletagmanager.com/gtag/js?id=" . esc_attr($seo_settings['google_analytics']) . "'></script>\n";
        echo "<script>\n";
        echo "window.dataLayer = window.dataLayer || [];\n";
        echo "function gtag(){dataLayer.push(arguments);}\n";
        echo "gtag('js', new Date());\n";
        echo "gtag('config', '" . esc_js($seo_settings['google_analytics']) . "');\n";
        echo "</script>\n";
        echo "<!-- End Google Analytics -->\n";
    }
}
add_action('wp_head', 'logic_nagoya_analytics_code');

/**
 * Google Tag Manager (Body)
 */
function logic_nagoya_gtm_body() {
    $seo_settings = get_field('seo_settings', 'option');
    
    if (!empty($seo_settings['google_tag_manager'])) {
        echo "<!-- Google Tag Manager (noscript) -->\n";
        echo "<noscript><iframe src='https://www.googletagmanager.com/ns.html?id=" . esc_attr($seo_settings['google_tag_manager']) . "'\n";
        echo "height='0' width='0' style='display:none;visibility:hidden'></iframe></noscript>\n";
        echo "<!-- End Google Tag Manager (noscript) -->\n";
    }
}
add_action('wp_body_open', 'logic_nagoya_gtm_body');

// ============================================================
// 9. 画像SEO最適化
// ============================================================

/**
 * 画像のalt属性自動生成
 */
function logic_nagoya_auto_image_alt($attr, $attachment, $size) {
    if (empty($attr['alt'])) {
        $alt_text = get_post_meta($attachment->ID, '_wp_attachment_image_alt', true);
        
        if (empty($alt_text)) {
            // ファイル名から自動生成
            $alt_text = pathinfo($attachment->post_title, PATHINFO_FILENAME);
            $alt_text = str_replace(['-', '_'], ' ', $alt_text);
            $alt_text = ucwords($alt_text);
            
            // Logic Nagoyaの情報を追加
            if (strpos($alt_text, 'Logic') === false && strpos($alt_text, 'Nagoya') === false) {
                $alt_text .= ' - Logic Nagoya';
            }
        }
        
        $attr['alt'] = $alt_text;
    }
    
    return $attr;
}
add_filter('wp_get_attachment_image_attributes', 'logic_nagoya_auto_image_alt', 10, 3);

/**
 * 画像ファイル名の最適化
 */
function logic_nagoya_optimize_image_filename($filename) {
    // 日本語ファイル名を英数字に変換
    $filename = sanitize_file_name($filename);
    
    // Logic Nagoya関連のキーワードを含む場合は維持
    if (preg_match('/logic|nagoya|event|live|venue/i', $filename)) {
        return $filename;
    }
    
    // 一般的な改善
    $filename = strtolower($filename);
    $filename = preg_replace('/[^a-z0-9\.-]/', '-', $filename);
    $filename = preg_replace('/-+/', '-', $filename);
    
    return $filename;
}
add_filter('sanitize_file_name', 'logic_nagoya_optimize_image_filename');

// ============================================================
// 10. SEO管理画面
// ============================================================

/**
 * SEO設定画面の追加
 */
function logic_nagoya_seo_admin_menu() {
    add_menu_page(
        'SEO設定',
        'SEO設定',
        'manage_options',
        'logic-nagoya-seo',
        'logic_nagoya_seo_admin_page',
        'dashicons-search',
        30
    );
}
add_action('admin_menu', 'logic_nagoya_seo_admin_menu');

/**
 * SEO設定画面のコールバック
 */
function logic_nagoya_seo_admin_page() {
    echo '<div class="wrap">';
    echo '<h1>SEO設定</h1>';
    
    // XMLサイトマップの再生成
    if (isset($_POST['regenerate_sitemap'])) {
        flush_rewrite_rules();
        echo '<div class="notice notice-success"><p>XMLサイトマップを再生成しました。</p></div>';
    }
    
    echo '<form method="post">';
    echo '<table class="form-table">';
    echo '<tr>';
    echo '<th>XMLサイトマップ</th>';
    echo '<td>';
    echo '<p><a href="' . home_url('/sitemap.xml') . '" target="_blank">メインサイトマップを表示</a></p>';
    echo '<input type="submit" name="regenerate_sitemap" value="サイトマップ再生成" class="button-secondary">';
    echo '</td>';
    echo '</tr>';
    echo '</table>';
    echo '</form>';
    
    // SEO チェックリスト
    echo '<h2>SEO チェックリスト</h2>';
    echo '<ul>';
    echo '<li>✅ メタタグの動的生成</li>';
    echo '<li>✅ 構造化データ（JSON-LD）</li>';
    echo '<li>✅ XMLサイトマップ</li>';
    echo '<li>✅ Open Graph・Twitter Cards</li>';
    echo '<li>✅ パンくずリスト</li>';
    echo '<li>✅ カノニカルURL</li>';
    echo '<li>✅ robots.txt最適化</li>';
    echo '<li>✅ 画像SEO最適化</li>';
    echo '</ul>';
    
    echo '</div>';
}

?>

/**
 * SEO最適化の実装完了により以下が達成されます：
 * 
 * ✅ 検索エンジンでの可視性向上
 * ✅ ローカルSEO対策（名古屋地域での検索優位性）
 * ✅ イベント情報の構造化データ対応
 * ✅ SNSでのシェア最適化
 * ✅ サイトマップ自動生成
 * ✅ 画像SEO最適化
 * ✅ 技術的SEO対策完備
 * 
 * これらの実装により、Logic Nagoyaのオンライン発見性が
 * 大幅に向上し、より多くの潜在顧客にリーチできます。
 */