<?php
/**
 * Logic Nagoya - 管理画面カスタマイズ完全ガイド
 * 
 * 非技術者でも簡単にコンテンツ管理ができる
 * 使いやすい管理画面インターフェースの実装
 */

// ============================================================
// 1. ダッシュボードカスタマイズ
// ============================================================

/**
 * カスタムダッシュボードウィジェット
 */
function logic_nagoya_dashboard_widgets() {
    // デフォルトウィジェットの削除
    remove_meta_box('dashboard_quick_press', 'dashboard', 'side');
    remove_meta_box('dashboard_recent_drafts', 'dashboard', 'side');
    remove_meta_box('dashboard_primary', 'dashboard', 'side');
    remove_meta_box('dashboard_secondary', 'dashboard', 'side');
    
    // カスタムウィジェットの追加
    wp_add_dashboard_widget(
        'logic_nagoya_events_overview',
        'イベント概要',
        'logic_nagoya_events_overview_widget'
    );
    
    wp_add_dashboard_widget(
        'logic_nagoya_quick_stats',
        'サイト統計',
        'logic_nagoya_quick_stats_widget'
    );
    
    wp_add_dashboard_widget(
        'logic_nagoya_quick_actions',
        'クイックアクション',
        'logic_nagoya_quick_actions_widget'
    );
    
    wp_add_dashboard_widget(
        'logic_nagoya_recent_inquiries',
        '最近のお問い合わせ',
        'logic_nagoya_recent_inquiries_widget'
    );
}
add_action('wp_dashboard_setup', 'logic_nagoya_dashboard_widgets');

/**
 * イベント概要ウィジェット
 */
function logic_nagoya_events_overview_widget() {
    // 今月のイベント数
    $this_month_events = new WP_Query([
        'post_type' => 'event',
        'posts_per_page' => -1,
        'meta_query' => [
            [
                'key' => 'event_date',
                'value' => [
                    date('Y-m-01'),
                    date('Y-m-t')
                ],
                'compare' => 'BETWEEN',
                'type' => 'DATE'
            ]
        ]
    ]);
    
    // 今後のイベント
    $upcoming_events = new WP_Query([
        'post_type' => 'event',
        'posts_per_page' => 5,
        'meta_key' => 'event_date',
        'orderby' => 'meta_value',
        'order' => 'ASC',
        'meta_query' => [
            [
                'key' => 'event_date',
                'value' => date('Y-m-d'),
                'compare' => '>=',
                'type' => 'DATE'
            ]
        ]
    ]);
    
    echo '<div class="logic-nagoya-dashboard-widget">';
    echo '<div class="dashboard-stats">';
    echo '<div class="stat-item">';
    echo '<span class="stat-number">' . $this_month_events->found_posts . '</span>';
    echo '<span class="stat-label">今月のイベント</span>';
    echo '</div>';
    echo '<div class="stat-item">';
    echo '<span class="stat-number">' . $upcoming_events->found_posts . '</span>';
    echo '<span class="stat-label">今後のイベント</span>';
    echo '</div>';
    echo '</div>';
    
    if ($upcoming_events->have_posts()) {
        echo '<h4>直近のイベント</h4>';
        echo '<ul class="upcoming-events-list">';
        while ($upcoming_events->have_posts()) {
            $upcoming_events->the_post();
            $event_date = get_field('event_date');
            echo '<li>';
            echo '<a href="' . get_edit_post_link() . '">';
            echo '<strong>' . get_the_title() . '</strong>';
            echo '<span class="event-date">' . date('m/d', strtotime($event_date)) . '</span>';
            echo '</a>';
            echo '</li>';
        }
        echo '</ul>';
        wp_reset_postdata();
    }
    
    echo '<p class="dashboard-widget-footer">';
    echo '<a href="' . admin_url('edit.php?post_type=event') . '" class="button">すべてのイベントを表示</a>';
    echo '<a href="' . admin_url('post-new.php?post_type=event') . '" class="button button-primary">新しいイベントを追加</a>';
    echo '</p>';
    echo '</div>';
}

/**
 * サイト統計ウィジェット
 */
function logic_nagoya_quick_stats_widget() {
    // 基本統計の取得
    $total_events = wp_count_posts('event')->publish;
    $total_equipment = wp_count_posts('equipment')->publish;
    $total_team = wp_count_posts('team_member')->publish;
    $total_testimonials = wp_count_posts('testimonial')->publish;
    
    echo '<div class="logic-nagoya-stats-grid">';
    
    echo '<div class="stat-box">';
    echo '<div class="stat-icon"><i class="dashicons dashicons-calendar-alt"></i></div>';
    echo '<div class="stat-content">';
    echo '<div class="stat-number">' . $total_events . '</div>';
    echo '<div class="stat-label">イベント総数</div>';
    echo '</div>';
    echo '</div>';
    
    echo '<div class="stat-box">';
    echo '<div class="stat-icon"><i class="dashicons dashicons-admin-tools"></i></div>';
    echo '<div class="stat-content">';
    echo '<div class="stat-number">' . $total_equipment . '</div>';
    echo '<div class="stat-label">設備アイテム</div>';
    echo '</div>';
    echo '</div>';
    
    echo '<div class="stat-box">';
    echo '<div class="stat-icon"><i class="dashicons dashicons-groups"></i></div>';
    echo '<div class="stat-content">';
    echo '<div class="stat-number">' . $total_team . '</div>';
    echo '<div class="stat-label">チームメンバー</div>';
    echo '</div>';
    echo '</div>';
    
    echo '<div class="stat-box">';
    echo '<div class="stat-icon"><i class="dashicons dashicons-format-quote"></i></div>';
    echo '<div class="stat-content">';
    echo '<div class="stat-number">' . $total_testimonials . '</div>';
    echo '<div class="stat-label">お客様の声</div>';
    echo '</div>';
    echo '</div>';
    
    echo '</div>';
}

/**
 * クイックアクションウィジェット
 */
function logic_nagoya_quick_actions_widget() {
    echo '<div class="logic-nagoya-quick-actions">';
    
    $actions = [
        [
            'title' => '新しいイベントを追加',
            'icon' => 'dashicons-plus-alt',
            'url' => admin_url('post-new.php?post_type=event'),
            'class' => 'button-primary'
        ],
        [
            'title' => '設備を管理',
            'icon' => 'dashicons-admin-tools',
            'url' => admin_url('edit.php?post_type=equipment'),
            'class' => 'button-secondary'
        ],
        [
            'title' => '料金設定を編集',
            'icon' => 'dashicons-money-alt',
            'url' => admin_url('admin.php?page=pricing-settings'),
            'class' => 'button-secondary'
        ],
        [
            'title' => 'サイト設定',
            'icon' => 'dashicons-admin-generic',
            'url' => admin_url('admin.php?page=site-settings'),
            'class' => 'button-secondary'
        ]
    ];
    
    foreach ($actions as $action) {
        echo '<a href="' . esc_url($action['url']) . '" class="quick-action-button ' . esc_attr($action['class']) . '">';
        echo '<i class="dashicons ' . esc_attr($action['icon']) . '"></i>';
        echo '<span>' . esc_html($action['title']) . '</span>';
        echo '</a>';
    }
    
    echo '</div>';
}

/**
 * 最近のお問い合わせウィジェット（Contact Form 7連携）
 */
function logic_nagoya_recent_inquiries_widget() {
    echo '<div class="logic-nagoya-inquiries">';
    echo '<p>お問い合わせの管理は<a href="' . admin_url('admin.php?page=wpcf7') . '">Contact Form 7</a>をご利用ください。</p>';
    
    // Google Analyticsへのリンク
    $analytics_id = get_field('google_analytics', 'option');
    if ($analytics_id) {
        echo '<p><a href="https://analytics.google.com/" target="_blank" rel="noopener noreferrer" class="button">Google Analytics を開く</a></p>';
    }
    
    echo '<h4>よく使用するリンク</h4>';
    echo '<ul>';
    echo '<li><a href="' . home_url('/') . '" target="_blank" rel="noopener noreferrer">サイトを表示</a></li>';
    echo '<li><a href="' . admin_url('admin.php?page=logic-nagoya-performance') . '">パフォーマンス設定</a></li>';
    echo '<li><a href="' . admin_url('admin.php?page=logic-nagoya-seo') . '">SEO設定</a></li>';
    echo '</ul>';
    echo '</div>';
}

// ============================================================
// 2. 管理画面のスタイル改善
// ============================================================

/**
 * 管理画面用CSS
 */
function logic_nagoya_admin_styles() {
    echo '<style>
    /* ダッシュボードウィジェットのスタイル */
    .logic-nagoya-dashboard-widget .dashboard-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .logic-nagoya-dashboard-widget .stat-item {
        flex: 1;
        text-align: center;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 4px;
    }
    
    .logic-nagoya-dashboard-widget .stat-number {
        display: block;
        font-size: 24px;
        font-weight: bold;
        color: #ca6666;
    }
    
    .logic-nagoya-dashboard-widget .stat-label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    .upcoming-events-list {
        margin: 0;
        padding: 0;
    }
    
    .upcoming-events-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .upcoming-events-list li:last-child {
        border-bottom: none;
    }
    
    .upcoming-events-list .event-date {
        font-size: 11px;
        color: #999;
        background: #f0f0f0;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    /* 統計グリッド */
    .logic-nagoya-stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    
    .stat-box {
        display: flex;
        align-items: center;
        padding: 15px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-icon {
        font-size: 24px;
        color: #ca6666;
        margin-right: 15px;
    }
    
    .stat-content .stat-number {
        font-size: 20px;
        font-weight: bold;
        line-height: 1;
    }
    
    .stat-content .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 2px;
    }
    
    /* クイックアクション */
    .logic-nagoya-quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .quick-action-button {
        display: flex;
        align-items: center;
        padding: 12px;
        text-decoration: none;
        border-radius: 4px;
        transition: all 0.2s;
    }
    
    .quick-action-button i {
        margin-right: 8px;
        font-size: 16px;
    }
    
    .quick-action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* カスタム投稿タイプの管理画面 */
    .post-type-event .wp-list-table .column-event_date,
    .post-type-event .wp-list-table .column-event_status {
        width: 120px;
    }
    
    .post-type-event .wp-list-table .column-event_category {
        width: 100px;
    }
    
    .event-status-upcoming { color: #46b450; }
    .event-status-sold_out { color: #dc3232; }
    .event-status-cancelled { color: #666; }
    .event-status-postponed { color: #ffb900; }
    .event-status-completed { color: #666; }
    
    /* ACFフィールドの改善 */
    .acf-field-group .acf-field-object {
        border-left: 4px solid #ca6666;
    }
    
    .acf-field[data-type="group"] > .acf-label {
        background: #f9f9f9;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    
    /* メニューアイコンのカスタマイズ */
    #adminmenu .wp-menu-image.dashicons-calendar-alt:before {
        color: #ca6666;
    }
    
    #adminmenu .wp-menu-image.dashicons-admin-tools:before {
        color: #ca6666;
    }
    
    #adminmenu .wp-menu-image.dashicons-groups:before {
        color: #ca6666;
    }
    </style>';
}
add_action('admin_head', 'logic_nagoya_admin_styles');

// ============================================================
// 3. カスタム投稿タイプの管理画面改善
// ============================================================

/**
 * イベント管理画面のカスタマイズ
 */
function logic_nagoya_event_admin_customization() {
    // カラムの追加
    add_filter('manage_event_posts_columns', 'logic_nagoya_event_columns');
    add_action('manage_event_posts_custom_column', 'logic_nagoya_event_column_content', 10, 2);
    add_filter('manage_edit-event_sortable_columns', 'logic_nagoya_event_sortable_columns');
    
    // フィルター機能の追加
    add_action('restrict_manage_posts', 'logic_nagoya_event_admin_filters');
    add_filter('parse_query', 'logic_nagoya_event_admin_filter_query');
    
    // クイック編集の機能追加
    add_action('quick_edit_custom_box', 'logic_nagoya_event_quick_edit', 10, 2);
    add_action('save_post', 'logic_nagoya_event_quick_edit_save');
    
    // 一括操作の追加
    add_filter('bulk_actions-edit-event', 'logic_nagoya_event_bulk_actions');
    add_filter('handle_bulk_actions-edit-event', 'logic_nagoya_event_bulk_action_handler', 10, 3);
}
add_action('admin_init', 'logic_nagoya_event_admin_customization');

/**
 * イベント管理画面のカラム設定
 */
function logic_nagoya_event_columns($columns) {
    $new_columns = [];
    $new_columns['cb'] = $columns['cb'];
    $new_columns['title'] = $columns['title'];
    $new_columns['event_image'] = 'イメージ';
    $new_columns['event_date'] = '開催日';
    $new_columns['event_time'] = '時間';
    $new_columns['event_status'] = '状況';
    $new_columns['event_category'] = 'カテゴリ';
    $new_columns['ticket_sales'] = 'チケット';
    $new_columns['date'] = $columns['date'];
    
    return $new_columns;
}

/**
 * カラムの内容表示
 */
function logic_nagoya_event_column_content($column, $post_id) {
    switch ($column) {
        case 'event_image':
            if (has_post_thumbnail($post_id)) {
                echo '<img src="' . get_the_post_thumbnail_url($post_id, 'thumbnail') . '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">';
            } else {
                echo '<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999;">画像なし</div>';
            }
            break;
            
        case 'event_date':
            $date = get_field('event_date', $post_id);
            if ($date) {
                $formatted_date = date('Y/m/d', strtotime($date));
                $day_of_week = ['日', '月', '火', '水', '木', '金', '土'][date('w', strtotime($date))];
                echo $formatted_date . '<br><small>(' . $day_of_week . ')</small>';
            } else {
                echo '<span style="color: #dc3232;">未設定</span>';
            }
            break;
            
        case 'event_time':
            $time_start = get_field('event_time_start', $post_id);
            $time_open = get_field('event_time_open', $post_id);
            
            if ($time_start || $time_open) {
                if ($time_start) echo '開場 ' . $time_start . '<br>';
                if ($time_open) echo '開演 ' . $time_open;
            } else {
                echo '<span style="color: #999;">未設定</span>';
            }
            break;
            
        case 'event_status':
            $status = get_field('event_status', $post_id);
            $status_labels = [
                'upcoming' => ['開催予定', 'upcoming'],
                'sold_out' => ['完売', 'sold_out'],
                'cancelled' => ['中止', 'cancelled'],
                'postponed' => ['延期', 'postponed'],
                'completed' => ['開催済み', 'completed'],
            ];
            
            if (isset($status_labels[$status])) {
                echo '<span class="event-status-' . $status_labels[$status][1] . '">' . $status_labels[$status][0] . '</span>';
            } else {
                echo '<span style="color: #999;">未設定</span>';
            }
            break;
            
        case 'event_category':
            $terms = get_the_terms($post_id, 'event_category');
            if ($terms && !is_wp_error($terms)) {
                $term_names = array_map(function($term) {
                    return '<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-size: 11px;">' . $term->name . '</span>';
                }, $terms);
                echo implode(' ', $term_names);
            } else {
                echo '<span style="color: #999;">未分類</span>';
            }
            break;
            
        case 'ticket_sales':
            $pricing = get_field('event_pricing', $post_id);
            if ($pricing && ($pricing['price_advance'] || $pricing['price_door'])) {
                if ($pricing['price_advance']) {
                    echo '前売 ¥' . number_format($pricing['price_advance']) . '<br>';
                }
                if ($pricing['price_door']) {
                    echo '当日 ¥' . number_format($pricing['price_door']);
                }
            } else {
                echo '<span style="color: #999;">料金未設定</span>';
            }
            break;
    }
}

/**
 * ソート可能カラムの設定
 */
function logic_nagoya_event_sortable_columns($columns) {
    $columns['event_date'] = 'event_date';
    $columns['event_status'] = 'event_status';
    return $columns;
}

/**
 * 管理画面フィルター
 */
function logic_nagoya_event_admin_filters() {
    global $typenow;
    
    if ($typenow === 'event') {
        // ステータスフィルター
        $status = isset($_GET['event_status']) ? $_GET['event_status'] : '';
        $status_options = [
            '' => 'すべてのステータス',
            'upcoming' => '開催予定',
            'sold_out' => '完売',
            'cancelled' => '中止',
            'postponed' => '延期',
            'completed' => '開催済み',
        ];
        
        echo '<select name="event_status">';
        foreach ($status_options as $value => $label) {
            echo '<option value="' . $value . '"' . selected($status, $value, false) . '>' . $label . '</option>';
        }
        echo '</select>';
        
        // 月別フィルター
        $month = isset($_GET['event_month']) ? $_GET['event_month'] : '';
        echo '<select name="event_month">';
        echo '<option value="">すべての月</option>';
        
        for ($i = 0; $i < 12; $i++) {
            $month_value = date('Y-m', strtotime("+$i months"));
            $month_label = date('Y年n月', strtotime("+$i months"));
            echo '<option value="' . $month_value . '"' . selected($month, $month_value, false) . '>' . $month_label . '</option>';
        }
        echo '</select>';
    }
}

/**
 * フィルタークエリの処理
 */
function logic_nagoya_event_admin_filter_query($query) {
    global $pagenow, $typenow;
    
    if ($pagenow === 'edit.php' && $typenow === 'event') {
        $meta_query = [];
        
        // ステータスフィルター
        if (!empty($_GET['event_status'])) {
            $meta_query[] = [
                'key' => 'event_status',
                'value' => sanitize_text_field($_GET['event_status']),
                'compare' => '='
            ];
        }
        
        // 月別フィルター
        if (!empty($_GET['event_month'])) {
            $month = sanitize_text_field($_GET['event_month']);
            $start_date = $month . '-01';
            $end_date = date('Y-m-t', strtotime($start_date));
            
            $meta_query[] = [
                'key' => 'event_date',
                'value' => [$start_date, $end_date],
                'compare' => 'BETWEEN',
                'type' => 'DATE'
            ];
        }
        
        if (!empty($meta_query)) {
            $query->query_vars['meta_query'] = $meta_query;
        }
    }
}

/**
 * クイック編集フィールド
 */
function logic_nagoya_event_quick_edit($column_name, $post_type) {
    if ($post_type !== 'event') return;
    
    if ($column_name === 'event_status') {
        echo '<fieldset class="inline-edit-col-right">';
        echo '<div class="inline-edit-col">';
        echo '<label class="inline-edit-status alignleft">';
        echo '<span class="title">イベント状況</span>';
        echo '<select name="event_status">';
        echo '<option value="">— 変更なし —</option>';
        echo '<option value="upcoming">開催予定</option>';
        echo '<option value="sold_out">完売</option>';
        echo '<option value="cancelled">中止</option>';
        echo '<option value="postponed">延期</option>';
        echo '<option value="completed">開催済み</option>';
        echo '</select>';
        echo '</label>';
        echo '</div>';
        echo '</fieldset>';
    }
}

/**
 * クイック編集の保存
 */
function logic_nagoya_event_quick_edit_save($post_id) {
    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
    if (!current_user_can('edit_post', $post_id)) return;
    if (get_post_type($post_id) !== 'event') return;
    
    if (isset($_POST['event_status']) && !empty($_POST['event_status'])) {
        update_field('event_status', sanitize_text_field($_POST['event_status']), $post_id);
    }
}

/**
 * 一括操作の追加
 */
function logic_nagoya_event_bulk_actions($bulk_actions) {
    $bulk_actions['mark_completed'] = '開催済みにする';
    $bulk_actions['mark_upcoming'] = '開催予定にする';
    $bulk_actions['mark_cancelled'] = '中止にする';
    return $bulk_actions;
}

/**
 * 一括操作の処理
 */
function logic_nagoya_event_bulk_action_handler($redirect_to, $doaction, $post_ids) {
    if (!in_array($doaction, ['mark_completed', 'mark_upcoming', 'mark_cancelled'])) {
        return $redirect_to;
    }
    
    $status_map = [
        'mark_completed' => 'completed',
        'mark_upcoming' => 'upcoming',
        'mark_cancelled' => 'cancelled'
    ];
    
    $status = $status_map[$doaction];
    $count = 0;
    
    foreach ($post_ids as $post_id) {
        if (get_post_type($post_id) === 'event') {
            update_field('event_status', $status, $post_id);
            $count++;
        }
    }
    
    $redirect_to = add_query_arg('bulk_events_processed', $count, $redirect_to);
    return $redirect_to;
}

// ============================================================
// 4. テーマカスタマイザー
// ============================================================

/**
 * テーマカスタマイザーの設定
 */
function logic_nagoya_customize_register($wp_customize) {
    // 基本設定セクション
    $wp_customize->add_section('logic_nagoya_basic', [
        'title' => 'Logic Nagoya 基本設定',
        'priority' => 30,
    ]);
    
    // サイトの色設定
    $wp_customize->add_setting('primary_color', [
        'default' => '#ca6666',
        'sanitize_callback' => 'sanitize_hex_color',
    ]);
    
    $wp_customize->add_control(new WP_Customize_Color_Control($wp_customize, 'primary_color', [
        'label' => 'プライマリカラー',
        'section' => 'logic_nagoya_basic',
        'settings' => 'primary_color',
    ]));
    
    // アクセントカラー
    $wp_customize->add_setting('accent_color', [
        'default' => '#e74c3c',
        'sanitize_callback' => 'sanitize_hex_color',
    ]);
    
    $wp_customize->add_control(new WP_Customize_Color_Control($wp_customize, 'accent_color', [
        'label' => 'アクセントカラー',
        'section' => 'logic_nagoya_basic',
        'settings' => 'accent_color',
    ]));
    
    // ヒーローセクションの設定
    $wp_customize->add_section('logic_nagoya_hero', [
        'title' => 'ヒーローセクション',
        'priority' => 31,
    ]);
    
    $wp_customize->add_setting('hero_title', [
        'default' => 'Logic Nagoya',
        'sanitize_callback' => 'sanitize_text_field',
    ]);
    
    $wp_customize->add_control('hero_title', [
        'label' => 'ヒーロータイトル',
        'section' => 'logic_nagoya_hero',
        'type' => 'text',
    ]);
    
    $wp_customize->add_setting('hero_subtitle', [
        'default' => '名古屋栄のプレミアムライブハウス',
        'sanitize_callback' => 'sanitize_textarea_field',
    ]);
    
    $wp_customize->add_control('hero_subtitle', [
        'label' => 'ヒーローサブタイトル',
        'section' => 'logic_nagoya_hero',
        'type' => 'textarea',
    ]);
    
    // SNS設定セクション
    $wp_customize->add_section('logic_nagoya_social', [
        'title' => 'SNS設定',
        'priority' => 32,
    ]);
    
    $social_platforms = [
        'twitter' => 'Twitter',
        'facebook' => 'Facebook',
        'instagram' => 'Instagram',
        'youtube' => 'YouTube'
    ];
    
    foreach ($social_platforms as $platform => $label) {
        $wp_customize->add_setting("social_${platform}", [
            'default' => '',
            'sanitize_callback' => 'esc_url_raw',
        ]);
        
        $wp_customize->add_control("social_${platform}", [
            'label' => $label . ' URL',
            'section' => 'logic_nagoya_social',
            'type' => 'url',
        ]);
    }
}
add_action('customize_register', 'logic_nagoya_customize_register');

/**
 * カスタマイザーのCSS出力
 */
function logic_nagoya_customize_css() {
    $primary_color = get_theme_mod('primary_color', '#ca6666');
    $accent_color = get_theme_mod('accent_color', '#e74c3c');
    
    echo '<style type="text/css">';
    echo ':root {';
    echo '--primary: ' . $primary_color . ';';
    echo '--accent: ' . $accent_color . ';';
    echo '}';
    echo '</style>';
}
add_action('wp_head', 'logic_nagoya_customize_css');

// ============================================================
// 5. ユーザーロール管理
// ============================================================

/**
 * カスタムユーザーロールの追加
 */
function logic_nagoya_add_user_roles() {
    // イベント管理者ロール
    add_role('event_manager', 'イベント管理者', [
        'read' => true,
        'edit_posts' => true,
        'edit_others_posts' => true,
        'edit_published_posts' => true,
        'publish_posts' => true,
        'delete_posts' => true,
        'delete_others_posts' => true,
        'delete_published_posts' => true,
        'upload_files' => true,
        'edit_events' => true,
        'edit_others_events' => true,
        'edit_published_events' => true,
        'publish_events' => true,
        'delete_events' => true,
        'manage_event_categories' => true,
    ]);
    
    // コンテンツ編集者ロール
    add_role('content_editor', 'コンテンツ編集者', [
        'read' => true,
        'edit_posts' => true,
        'edit_published_posts' => true,
        'upload_files' => true,
        'edit_events' => true,
        'edit_equipment' => true,
        'edit_team_members' => true,
        'edit_testimonials' => true,
    ]);
}
add_action('init', 'logic_nagoya_add_user_roles');

/**
 * 管理画面メニューの権限調整
 */
function logic_nagoya_admin_menu_permissions() {
    // イベント管理者は特定メニューのみアクセス可能
    if (current_user_can('event_manager') && !current_user_can('administrator')) {
        remove_menu_page('tools.php');
        remove_menu_page('plugins.php');
        remove_menu_page('themes.php');
        remove_menu_page('users.php');
        remove_menu_page('options-general.php');
    }
    
    // コンテンツ編集者はさらに制限
    if (current_user_can('content_editor') && !current_user_can('event_manager')) {
        remove_menu_page('tools.php');
        remove_menu_page('plugins.php');
        remove_menu_page('themes.php');
        remove_menu_page('users.php');
        remove_menu_page('options-general.php');
        remove_menu_page('edit-comments.php');
    }
}
add_action('admin_menu', 'logic_nagoya_admin_menu_permissions', 999);

// ============================================================
// 6. ヘルプとガイド機能
// ============================================================

/**
 * コンテキストヘルプの追加
 */
function logic_nagoya_contextual_help($screen) {
    if ($screen->post_type === 'event') {
        $help_content = '<h3>イベント管理のヘルプ</h3>';
        $help_content .= '<p><strong>イベント作成の手順：</strong></p>';
        $help_content .= '<ol>';
        $help_content .= '<li>イベントタイトルを入力</li>';
        $help_content .= '<li>イベントの詳細を記入</li>';
        $help_content .= '<li>アイキャッチ画像を設定</li>';
        $help_content .= '<li>開催日・時間を設定</li>';
        $help_content .= '<li>料金情報を入力</li>';
        $help_content .= '<li>出演者情報を追加</li>';
        $help_content .= '<li>カテゴリとタグを設定</li>';
        $help_content .= '</ol>';
        $help_content .= '<p><strong>ヒント：</strong>アイキャッチ画像は1200×630ピクセル推奨</p>';
        
        $screen->add_help_tab([
            'id' => 'logic_nagoya_event_help',
            'title' => 'イベント作成ガイド',
            'content' => $help_content,
        ]);
    }
}
add_action('current_screen', 'logic_nagoya_contextual_help');

/**
 * 管理画面にヘルプウィジェットを追加
 */
function logic_nagoya_help_widget() {
    wp_add_dashboard_widget(
        'logic_nagoya_help',
        'Logic Nagoya 使い方ガイド',
        'logic_nagoya_help_widget_content'
    );
}

function logic_nagoya_help_widget_content() {
    echo '<div class="logic-nagoya-help">';
    echo '<h4>よく使用する機能</h4>';
    echo '<ul>';
    echo '<li><a href="' . admin_url('post-new.php?post_type=event') . '">新しいイベントを追加</a></li>';
    echo '<li><a href="' . admin_url('edit.php?post_type=equipment') . '">設備情報を管理</a></li>';
    echo '<li><a href="' . admin_url('admin.php?page=pricing-settings') . '">料金設定を変更</a></li>';
    echo '<li><a href="' . admin_url('customize.php') . '">サイトデザインをカスタマイズ</a></li>';
    echo '</ul>';
    
    echo '<h4>お困りの際は</h4>';
    echo '<p>操作方法がわからない場合は、各ページの「ヘルプ」タブをご確認ください。</p>';
    echo '<p>技術的なサポートが必要な場合は、<a href="mailto:support@logicnagoya.com">サポートチーム</a>までお気軽にお問い合わせください。</p>';
    echo '</div>';
}
add_action('wp_dashboard_setup', 'logic_nagoya_help_widget');

// ============================================================
// 7. 管理画面のブランディング
// ============================================================

/**
 * ログイン画面のカスタマイズ
 */
function logic_nagoya_login_customization() {
    echo '<style>
    .login h1 a {
        background-image: url(' . get_template_directory_uri() . '/assets/images/logo.png);
        background-size: contain;
        width: 200px;
        height: 80px;
    }
    
    .login form {
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .wp-core-ui .button-primary {
        background: #ca6666;
        border-color: #ca6666;
        box-shadow: none;
        text-shadow: none;
    }
    
    .wp-core-ui .button-primary:hover {
        background: #b85555;
        border-color: #b85555;
    }
    
    input[type="text"]:focus,
    input[type="password"]:focus {
        border-color: #ca6666;
        box-shadow: 0 0 0 1px #ca6666;
    }
    </style>';
}
add_action('login_head', 'logic_nagoya_login_customization');

/**
 * ログインロゴのリンク先変更
 */
function logic_nagoya_login_logo_url() {
    return home_url('/');
}
add_filter('login_headerurl', 'logic_nagoya_login_logo_url');

/**
 * ログインロゴのタイトル変更
 */
function logic_nagoya_login_logo_title() {
    return get_bloginfo('name');
}
add_filter('login_headertitle', 'logic_nagoya_login_logo_title');

/**
 * 管理画面フッターテキストの変更
 */
function logic_nagoya_admin_footer_text() {
    return '<span id="footer-thankyou">Logic Nagoya WordPressサイト - 管理画面</span>';
}
add_filter('admin_footer_text', 'logic_nagoya_admin_footer_text');

// ============================================================
// 8. 通知とアラート機能
// ============================================================

/**
 * 管理画面通知の追加
 */
function logic_nagoya_admin_notices() {
    // 一括操作完了の通知
    if (isset($_GET['bulk_events_processed'])) {
        $count = intval($_GET['bulk_events_processed']);
        echo '<div class="notice notice-success is-dismissible">';
        echo '<p>' . sprintf('%d件のイベントステータスを更新しました。', $count) . '</p>';
        echo '</div>';
    }
    
    // 今日開催のイベントがある場合の通知
    $today_events = new WP_Query([
        'post_type' => 'event',
        'posts_per_page' => -1,
        'meta_query' => [
            [
                'key' => 'event_date',
                'value' => date('Y-m-d'),
                'compare' => '=',
                'type' => 'DATE'
            ]
        ]
    ]);
    
    if ($today_events->have_posts()) {
        echo '<div class="notice notice-info">';
        echo '<p><strong>今日開催のイベントがあります：</strong></p>';
        echo '<ul>';
        while ($today_events->have_posts()) {
            $today_events->the_post();
            echo '<li><a href="' . get_edit_post_link() . '">' . get_the_title() . '</a></li>';
        }
        echo '</ul>';
        echo '</div>';
        wp_reset_postdata();
    }
}
add_action('admin_notices', 'logic_nagoya_admin_notices');

?>

/**
 * 管理画面カスタマイズの実装により以下が実現されます：
 * 
 * ✅ 直感的で使いやすいダッシュボード
 * ✅ イベント管理の効率化
 * ✅ 非技術者でも簡単な操作
 * ✅ 視覚的にわかりやすいインターフェース
 * ✅ ロール別権限管理
 * ✅ 充実したヘルプ機能
 * ✅ ブランド統一されたデザイン
 * ✅ 効率的な一括操作
 * ✅ リアルタイム通知機能
 * 
 * これらにより、Logic Nagoyaのスタッフは技術的な知識なしでも
 * 簡単にウェブサイトを管理・更新できるようになります。
 */